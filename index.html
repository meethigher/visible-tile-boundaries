<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Visible Tile Boundaries</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
<div id="map" style="width:100vw;height:100vh;"></div>
<script>

    /**
     * 创建一个生成瓦片边界的png
     */
    function createBase64Tile(z, x, y) {
        const canvas = document.createElement('canvas');
        const size = 256;
        canvas.width = size;
        canvas.height = size;
        const context = canvas.getContext('2d');
        context.clearRect(0, 0, size, size);
        //绘制边框
        context.strokeStyle = 'black';
        context.lineWidth = 1;
        context.strokeRect(0, 0, size, size);
        //绘制额字体
        context.font = '20px Arial';
        context.fillStyle = 'black';
        context.textAlign = 'left';
        context.textBaseline = 'top';
        //字体竖着展示
        context.fillText(`z: ${z}`, 10, 10);
        context.fillText(`x: ${x}`, 10, 30);
        context.fillText(`y: ${y}`, 10, 50);
        //字体并排展示
        // const text = `z: ${z}, x: ${x}, y: ${y}`;
        // context.fillText(text, 10, 10)
        return canvas.toDataURL('image/png');
    }


    //对tilelayer进行定制化，对于不符合规范的url瓦片不进行请求
    L.TileLayer.Custom = L.TileLayer.extend({
        getTileUrl: function (coords) {
            // 获取z、x、y参数
            let z = coords.z;
            let x = coords.x;
            let y = coords.y;

            // 校验z、x、y参数
            if (this.isValidTile(z, x, y)) {
                // 返回有效的切片URL
                return L.TileLayer.prototype.getTileUrl.call(this, coords);
            } else {
                return "";
            }
        },
        isValidTile: function (z, x, y) {
            let maxIndex = Math.pow(2, z) - 1;
            if (z < 0 || x < 0 || y < 0 || x > maxIndex || y > maxIndex) {
                return false;
            } else {
                return true;
            }
        }
    });

    //对tilelayer进行定制化，不请求url，而是使用实时渲染的base64
    L.TileLayer.Base64 = L.TileLayer.extend({
        getTileUrl: function (coords) {
            // 获取z、x、y参数
            let z = coords.z;
            let x = coords.x;
            let y = coords.y;
            // 校验z、x、y参数
            if (this.isValidTile(z, x, y)) {
                return createBase64Tile(z, x, y);
            } else {
                return 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAAAAAB5Gfe6AAAACXBIWXMAAA7EAAAOxAGVKw4bAAABOElEQVR42u3QgQAAAAwEofd3PJeBrBBaz02AAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAioA1wPDPTdUxI5AAAAAElFTkSuQmCC';
            }

        },
        isValidTile: function (z, x, y) {
            let maxIndex = Math.pow(2, z) - 1;
            if (z < 0 || x < 0 || y < 0 || x > maxIndex || y > maxIndex) {
                return false;
            } else {
                return true;
            }
        },

        createTile: function (coords, done) {
            var tile = document.createElement('img');
            tile.onload = function () {
                done(null, tile);
            };
            tile.onerror = function () {
                done(new Error('Tile loading error'), tile);
            };
            var url = this.getTileUrl(coords);
            if (url) {
                tile.src = url;
            } else {
                done(new Error('Tile not found'), tile);
            }
            return tile;
        }
    });
</script>
<script>
    window.onload = function () {
        var opts = {"zoomSnap": 0.1, "zoomDelta": 0.1}
        var map = L.map(document.getElementById("map"), opts).setView([1, 0], 0);
        //zIndex大的layer会将小的layer覆盖掉。但实际请求的速度是以代码顺序由前往后加载的。
        let sourceLayer = new L.TileLayer.Custom("https://meethigher.top/wkt/{z}/{x}/{y}", {
            noWrap: true,
            maxZoom: 10,
            zIndex: 1
        });
        let boundaryLayer = new L.TileLayer.Base64("https://layer.clockworkmicro.com/v1/webtileboundaries?z={z}&x={x}&y={y}", {
            noWrap: true,
            maxZoom: 10,
            zIndex: 99
        })
        boundaryLayer.addTo(map)

        sourceLayer.addTo(map);

    }
</script>
</body>
</html>